#!/bin/bash
# Définir les variables
DB_USER="{{ db_user }}"
DB_PASSWORD="{{ db_password }}"
DB_NAME="{{ db_name }}"
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="{{ backup_directory }}"
LIMIT=2  # Nombre de sauvegardes à conserver

# Exécuter mysqldump
mysqldump -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# Compression du fichier de sauvegarde
gzip $BACKUP_DIR/db_backup_$DATE.sql

BACKUP_FILE="$BACKUP_DIR/db_backup_$DATE.sql.gz"

# Supprimer les anciens fichiers .sql.gz
cd $BACKUP_DIR
ls -t db_backup_*.sql.gz | tail -n +$(($LIMIT+1)) | xargs rm -f

# Vérifier la date de modification du fichier de sauvegarde
if [ -f "$BACKUP_FILE" ]; then
    LAST_MODIFIED=$(stat -c %Y "$BACKUP_FILE")
    CURRENT_TIME=$(date +%s)
    ELAPSED_TIME=$((CURRENT_TIME - LAST_MODIFIED))

    # Si la sauvegarde a été mise à jour récemment, afficher un message
    if [ $ELAPSED_TIME -lt 300 ]; then  # 300 secondes = 5 minutes
        echo "La sauvegarde a été mise à jour récemment."
    else
        echo "La sauvegarde n'a pas été mise à jour récemment."
    fi
else
    echo "Le fichier de sauvegarde n'existe pas."
fi
